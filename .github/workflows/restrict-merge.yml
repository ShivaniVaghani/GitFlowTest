name: Enforce GitFlow Merge Rules

on:
  pull_request:
    branches:
      - main
      - 'release/*'
      - develop

jobs:
  check-merge-source:
    runs-on: ubuntu-latest
    steps:
      - name: Check source and target branches
        run: |
          TARGET="${{ github.base_ref }}"
          SOURCE="${{ github.head_ref }}"

          echo "üîç Target: $TARGET"
          echo "üîç Source: $SOURCE"

          # Rule 1: main ‚Üê release/* or hotfix/*
          if [[ "$TARGET" == "main" ]]; then
            if [[ ! "$SOURCE" =~ ^release/.* && ! "$SOURCE" =~ ^hotfix/.* ]]; then
              echo "‚ùå main can only be merged into from release/* or hotfix/*"
              exit 1
            fi
          fi

          # Rule 2: release/* ‚Üê develop or hotfix/*
          if [[ "$TARGET" =~ ^release/.* ]]; then
            if [[ "$SOURCE" != "develop" && ! "$SOURCE" =~ ^hotfix/.* ]]; then
              echo "‚ùå release/* can only be merged into from develop or hotfix/*"
              exit 1
            fi
          fi

          # Rule 3: develop ‚Üê feature/* or hotfix/*
          if [[ "$TARGET" == "develop" ]]; then
            if [[ ! "$SOURCE" =~ ^feature/.* && ! "$SOURCE" =~ ^hotfix/.* ]]; then
              echo "‚ùå develop can only be merged into from feature/* or hotfix/*"
              exit 1
            fi
          fi

          echo "‚úÖ Merge source is allowed."
